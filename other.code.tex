\input preamble.tex
\input review.code.tex
\usepackage{rv-utils}

\geometry{
  left=2cm,
  right=2cm,
  top=2.5cm,
  bottom=2.5cm,
}

\ExplSyntaxOn

\tl_new:N \g__rv_cs_review_tl
\clist_new:N \g__rv_review_point_clist
\bool_new:N \g__rv_group_bool

\keys_define:nn { rv_review }
  {
    review~point .clist_gset:N = \g__rv_review_point_clist,
    class .code:n = { \__rv_parse_class_env:n { #1 } },
    group .bool_set:N = \g__rv_group_bool,
  }

% \cs_generate_variant:Nn \__rv_set_single_class:n { x }
\cs_generate_variant:Nn \__rv_set_single_class_kv:n { x }
\cs_generate_variant:Nn \__rv_single_class_kv_init:n { x }

\cs_new_protected:Nn \__rv_broadcast:n
  {
    \__rv_class_not_set:
    \seq_map_inline:Nn \g__rv_class_seq
      {
      }
  }

\NewDocumentCommand { \rvsetup } { m }
  {
    \keys_set:nn { rv_review } { #1 }
  }

\prg_new_protected_conditional:Nnn \__rv_if_review:n { T, F, TF }
  {
    \review_if:NnTF \g__rv_review_point_clist { #1 }
      { \prg_return_true: }
      { \prg_return_false: }
  }

\NewDocumentCommand { \setclass } { m }
  {
    \__rv_parse_class_env:n { #1 }
  }

% key rv<key>
% key=val <val>
% #1 key | key=val
\cs_new_protected:Nn \__rv_parse_class_env:n
  {
    \__rv_multi_class_options:
    \seq_gclear_new:N \g__rv_class_seq
    \seq_gclear_new:N \g__rv_env_seq
    \clist_map_inline:nn { #1 }
      {
        \str_if_in:nnTF { ##1 } { = }
          { \__rv_save_class_env:n { ##1 } }
          { \__rv_save_class_env:n { ##1=rv##1 } }
      }
  }

\cs_new_protected:Nn \__rv_save_class_env:n
  {
    \rv_do_kv:nn { #1 }
      {
        \__rv_single_class_init:nn { ##1 } { ##2 }
        \__rv_set_single_class_kv:n { ##1 }
        \__rv_single_class_kv_init:n { ##1 }
        \__rv_set_rvenv:n { ##2 }
      }
  }

% #1 class #2 class env
\cs_new_protected:Nn \__rv_single_class_init:nn
  {
    \seq_gput_right:Nn \g__rv_class_seq { ##1 }
    \seq_gput_right:Nn \g__rv_env_seq { ##2 }

    \tl_clear_new:N \l__rv_class_tl
    \tl_clear_new:N \l__rv_env_tl

    \tl_set:Nn \l__rv_class_tl { ##1 }
    \tl_set:Nn \l__rv_env_tl { ##2 }

    \seq_gclear_new:c { g__rv_#1_date_seq }
    \seq_gclear_new:c { g__rv_#1_info_seq }
    \seq_gclear_new:c { g__rv_#1_star_date_seq }
    \seq_gclear_new:c { g__rv_#1_star_info_seq }
    \seq_gclear_new:c { g__rv_#1_star_item_seq }
    \seq_gclear_new:c { g__rv_#1_star_errortimes_seq }
    \int_gzero_new:c { g__rv_#1_groupid_int }

    \bool_if_exist:cF { g__rv_#1_group_bool }
      { \bool_new:c { g__rv_#1_group_bool } }
  }

\cs_new_protected:Nn \__rv_set_single_class_kv:n
  {
    \keys_define:nn { rv_review / #1 }
      {
        rv-cmd .tl_gset:N = \g__rv_cs_review_tl,
      }
  }

\cs_new_protected:Nn \__rv_single_class_kv_init:n
  {
    \keys_set:nn { rv_review / #1 }
      {
        rv-cmd = \review,
      }
  }

\cs_new_protected:Nn \__rv_set_group_env:n
  {
  }
%%%%%%%%%% %%%%%%%%%% %%%%%%%%%% %%%%%%%%%%
%%%%%%%%%% %%%%%%%%%% %%%%%%%%%% %%%%%%%%%%
\cs_new_protected:Nn \__rv_set_rvenv:n
  {
    % #1 date #2 info
    \DeclareDocumentEnvironment { #1 } { m m +b }
      {
        \__rv_set_review_group_conditianal:n { ##1 }
        \__rv_env_init:nnn { \l__rv_class_tl } { ##1 } { ##2 }
        \__rv_set_review:
        ##3
      } {}
  }

\cs_new_protected:Nn \__rv_set_review_group_conditianal:n
  {
    \prg_set_protected_conditional:Nnn \__rv_if_review_group: { T, F, TF }
      {
        \__rv_if_review:nTF { #1 }
          { \prg_return_true: }
          { \prg_return_false: }
      }
  }

% #1 class #2 date #3 info
\cs_new_protected:Nn \__rv_env_init:nnn
  {
    \__rv_if_review_group:T
      {
        \int_gincr:c { g__rv_#1_groupid_int }
        \int_zero_new:N \l__rv_groupid_int
        \int_set_eq:Nc \l__rv_groupid_int { g__rv_#1_groupid_int }

        \tl_clear_new:N \l__rv_prefix_tl
        \tl_set:Nx \l__rv_prefix_tl
          { g__rv_#1_group\int_use:N \l__rv_groupid_int }
        \seq_gclear_new:c { \l__rv_prefix_tl _errortimes_seq }
        \seq_gclear_new:c { \l__rv_prefix_tl _item_seq }

        \seq_gput_right:cn { g__rv_#1_date_seq } { #2 }
        \seq_gput_right:cn { g__rv_#1_info_seq } { #3 }
      }
    % \tl_clear_new:N \l__rv_class_tl
    \tl_clear_new:N \l__rv_date_tl
    \tl_clear_new:N \l__rv_info_tl

    % \tl_set:Nn \l__rv_class_tl { #1 }
    \tl_set:Nn \l__rv_date_tl { #2 }
    \tl_set:Nn \l__rv_info_tl { #3 }
  }

\cs_new_protected:Nn \__rv_set_review:
  {
    % #1 error date #2 error times #3 item
    \DeclareDocumentCommand { \__rv_cs_review } { o D(){2} m }
      {
        \IfValueT { ##1 }
          {
            \__rv_if_review:nT { ##1 }
              {
                % prevent duplication
                \__rv_if_review_group:F
                  {
                    \__rv_star_save:nnn { ##1 } { ##2 } { ##3 }
                  }
              }
          }
        \__rv_if_review_group:T
          { \__rv_normal_save:nn { ##2 } { ##3 } }
      }
    \cs_set_eq:cN { \g__rv_cs_review_tl } \__rv_cs_review
  }

\cs_new_protected:Nn \__rv_star_save:nnn
  {
    \seq_gput_right:cn
      { g__rv_\l__rv_class_tl _star_date_seq }
      { #1 }
    \seq_gput_right:cn
      { g__rv_\l__rv_class_tl _star_errortimes_seq }
      { #2 }
    \seq_gput_right:cn
      { g__rv_\l__rv_class_tl _star_item_seq }
      { #3 }
    \seq_gput_right:cV
      { g__rv_\l__rv_class_tl _star_info_seq }
      \l__rv_info_tl
  }

\cs_new_protected:Nn \__rv_normal_save:nn
  {
    \seq_gput_right:cn
      { \l__rv_prefix_tl _errortimes_seq }
      { #1 }
    \seq_gput_right:cn
      { \l__rv_prefix_tl _item_seq }
      { #2 }
  }

\AtEndDocument{
  % \seq_use:Nn \g__rv_env_seq { ,~ }
  % \__rv_show:
}

\cs_new_protected:Nn \__rv_show:
  {
    \seq_map_variable:NNn \g__rv_class_seq \l__rv_class_tl
      {
        \__rv_show_init:
        \__rv_show_class:
      }
  }

\cs_new_protected:Nn \__rv_show_init:
  {
    \__rv_set_local_seq:n
      {
        date, star_date,
        info, star_info,
        star_item,
        star_errortimes
      }

    \int_zero_new:N \l__rv_groupid_int
    % \int_zero_new:N \l__rv_number_int
    \int_zero_new:N \l__rv_star_number_int

    % \int_set_eq:Nc \l__rv_number_int { g__rv_\l__rv_class_tl _groupid_int }
    \int_set:Nn \l__rv_star_number_int
      { \seq_count:N \l__rv_star_date_seq }
  }

\cs_new_protected:Nn \__rv_set_local_seq:n
  {
    \clist_map_inline:nn { #1 }
      {
        \seq_clear_new:c { l__rv_##1_seq }
        \seq_set_eq:cc { l__rv_##1_seq }
          { g__rv_\l__rv_class_tl _##1_seq }
      }
  }

\cs_new_protected:Nn \__rv_show_class:
  {
    \__rv_show_pre:
    \__rv_show_star:
    \__rv_show_normal:
  }

\cs_new_protected:Nn \__rv_show_pre:
  {
    \section{\l__rv_class_tl}
  }

\cs_new_protected:Nn \__rv_show_star:
  {
    \subsection{易错}
    \int_step_inline:nn { \l__rv_star_number_int }
      {
        \__rv_set_local_tl:nn { ##1 }
          {
            star_date, star_info,
            star_item, star_errortimes
          }
        \l__rv_star_date_tl+
        \l__rv_star_info_tl+
        \l__rv_star_item_tl+
        \l__rv_star_errortimes_tl
      }
  }

% #1 number #2 list
\cs_new_protected:Nn \__rv_set_local_tl:nn
  {
    \clist_map_inline:nn { #2 }
      {
        \tl_clear_new:c { l__rv_##1_tl }
        \tl_set:cx { l__rv_##1_tl }
          { \seq_item:cn { l__rv_##1_seq } { #1 } }
      }
  }

\cs_new_protected:Nn \__rv_show_normal:
  {
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\msg_new:nnn { review } { class-not-set }
  {
    Review~ classes~ is~ not~ set~ or~ empty.~ Please~ set~ classes~ by~
    option~ 'class'~ or~ command~ '\c_backslash_str setclass'~ before~ using~ other~
    subkeys.
  }

\msg_new:nnn { review } { multi-class-options }
  {
    Please~ do~ not~ set~ review~ classes~ multiple~ times!~ Check~ if~
    there~ are~ duplicated~ 'class'~ options~ or~ '\c_backslash_str setclass'~
    commands.
  }

\cs_new_protected:Nn \__rv_class_not_set:
  {
    \bool_if:nT
      {
        ! \seq_if_exist_p:N \g__rv_class_seq ||
        \seq_if_empty_p:N \g__rv_class_seq
      }
      { \msg_error:nn { review } { class-not-set } }
  }

\cs_new_protected:Nn \__rv_multi_class_options:
  {
    \seq_if_exist:NT \g__rv_class_seq
      { \msg_error:nn { review } { multi-class-options } }
  }


\ExplSyntaxOff
\endinput
